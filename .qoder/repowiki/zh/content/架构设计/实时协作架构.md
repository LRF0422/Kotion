# 实时协作架构

<cite>
**本文引用的文件**
- [packages/editor/src/extensions/sync-block/SyncBlock.tsx](file://packages/editor/src/extensions/sync-block/SyncBlock.tsx)
- [packages/editor/src/extensions/sync-block/sync-block.ts](file://packages/editor/src/extensions/sync-block/sync-block.ts)
- [packages/editor/src/editor/collaboration.tsx](file://packages/editor/src/editor/collaboration.tsx)
- [packages/editor/src/editor/render.tsx](file://packages/editor/src/editor/render.tsx)
- [packages/editor/src/server/server.mjs](file://packages/editor/src/server/server.mjs)
- [packages/editor/package.json](file://packages/editor/package.json)
- [packages/plugin-main/src/pages/Journals/JournalEditor/index.tsx](file://packages/plugin-main/src/pages/Journals/JournalEditor/index.tsx)
- [packages/plugin-main/src/pages/PageRoom/index.tsx](file://packages/plugin-main/src/pages/PageRoom/index.tsx)
- [packages/editor/src/styles/editor.ts](file://packages/editor/src/styles/editor.ts)
- [packages/editor/src/extensions/undo-redo/history.ts](file://packages/editor/src/extensions/undo-redo/history.ts)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 引言
本文件面向知识库管理系统的实时协作架构，围绕 Yjs 协作引擎与 Hocuspocus 协作服务器的集成进行系统化说明。重点涵盖：
- CRDT 数据结构与冲突自由合并原理在编辑器中的应用
- Hocuspocus 协作服务器的连接与通信协议要点
- SyncBlock 同步块的设计理念与内容块级协作编辑实现
- 协作状态管理（用户光标、选区、在线用户）策略
- 冲突检测与自动解决算法（基于 Yjs 的 OT/CRDT）
- 性能优化策略（增量同步、内存管理、网络优化）
- 调试方法与常见问题排查

## 项目结构
协作能力由“编辑器前端 + 协作服务器”两部分组成：
- 编辑器前端：基于 Tiptap/Yjs，通过 @hocuspocus/provider 连接 Hocuspocus 服务器，支持页面级与块级协作
- 协作服务器：基于 @hocuspocus/server，使用扩展实现持久化与分布式广播（示例中采用 MySQL/Redis 扩展）

```mermaid
graph TB
subgraph "编辑器前端"
FE_Page["页面编辑器<br/>CollaborationEditor"]
FE_Block["同步块编辑器<br/>SyncBlockView"]
Provider["@hocuspocus/provider<br/>TiptapCollabProvider"]
end
subgraph "协作服务器"
HServer["@hocuspocus/server"]
ExtMySQL["@hocuspocus/extension-mysql"]
ExtRedis["@hocuspocus/extension-redis"]
ExtLogger["@hocuspocus/extension-logger"]
end
FE_Page --> Provider
FE_Block --> Provider
Provider --> HServer
HServer --> ExtMySQL
HServer --> ExtRedis
HServer --> ExtLogger
```

图表来源
- [packages/editor/src/editor/collaboration.tsx](file://packages/editor/src/editor/collaboration.tsx#L1-L142)
- [packages/editor/src/extensions/sync-block/SyncBlock.tsx](file://packages/editor/src/extensions/sync-block/SyncBlock.tsx#L1-L87)
- [packages/editor/src/server/server.mjs](file://packages/editor/src/server/server.mjs#L1-L26)
- [packages/editor/package.json](file://packages/editor/package.json#L1-L104)

章节来源
- [packages/editor/src/editor/collaboration.tsx](file://packages/editor/src/editor/collaboration.tsx#L1-L142)
- [packages/editor/src/extensions/sync-block/SyncBlock.tsx](file://packages/editor/src/extensions/sync-block/SyncBlock.tsx#L1-L87)
- [packages/editor/src/server/server.mjs](file://packages/editor/src/server/server.mjs#L1-L26)
- [packages/editor/package.json](file://packages/editor/package.json#L1-L104)

## 核心组件
- 页面级协作编辑器：负责整页内容的协作渲染与事件处理，承载菜单、目录等 UI，并通过 Provider 管理连接状态
- 同步块（SyncBlock）：以独立 Y.Doc 与 Provider 实现内容块级协作，隔离不同块的变更流
- Hocuspocus 协作服务器：统一接收来自各客户端的增量更新，经扩展持久化与广播给其他订阅者
- 用户光标与选区：通过 Awareness 机制共享用户状态（含光标位置、选区），样式由编辑器样式定义

章节来源
- [packages/editor/src/editor/collaboration.tsx](file://packages/editor/src/editor/collaboration.tsx#L1-L142)
- [packages/editor/src/extensions/sync-block/SyncBlock.tsx](file://packages/editor/src/extensions/sync-block/SyncBlock.tsx#L1-L87)
- [packages/editor/src/server/server.mjs](file://packages/editor/src/server/server.mjs#L1-L26)
- [packages/editor/src/styles/editor.ts](file://packages/editor/src/styles/editor.ts#L740-L802)

## 架构总览
下图展示从页面/块进入编辑器到 Hocuspocus 服务器的完整流程，包括连接建立、增量同步与广播。

```mermaid
sequenceDiagram
participant UI as "页面/块编辑器"
participant Provider as "TiptapCollabProvider"
participant Server as "Hocuspocus 服务器"
participant Store as "持久化/广播扩展"
UI->>Provider : 初始化 Provider设置 name/token/document
Provider->>Server : 建立 WebSocket 连接
Server->>Store : 订阅频道name
Provider->>Server : 发送初始快照/增量
Server-->>Provider : 广播其他客户端增量
Provider-->>UI : 触发本地更新事务/渲染
UI->>Provider : 用户输入产生新增量
Provider->>Server : 上行增量
Server->>Store : 持久化/转发
Server-->>Provider : 下行增量其他客户端
```

图表来源
- [packages/plugin-main/src/pages/Journals/JournalEditor/index.tsx](file://packages/plugin-main/src/pages/Journals/JournalEditor/index.tsx#L1-L54)
- [packages/editor/src/extensions/sync-block/SyncBlock.tsx](file://packages/editor/src/extensions/sync-block/SyncBlock.tsx#L1-L87)
- [packages/editor/src/server/server.mjs](file://packages/editor/src/server/server.mjs#L1-L26)

## 详细组件分析

### 页面级协作编辑器（CollaborationEditor）
- 负责整页协作渲染，挂载菜单、目录等 UI 组件
- 通过 useEditor 创建编辑器实例，配置扩展与属性
- 通过 Provider 管理连接生命周期（连接、断开、销毁）
- 提供状态回调（onStatus）、Awareness 更新（onAwarenessUpdate）等钩子

```mermaid
flowchart TD
Start(["进入页面编辑器"]) --> Init["初始化编辑器与扩展"]
Init --> Connect["创建 Provider 并连接"]
Connect --> Render["渲染编辑器与菜单"]
Render --> Events{"用户交互/远程增量?"}
Events --> |本地| LocalTx["生成增量事务"]
Events --> |远程| RemoteTx["接收增量并应用"]
LocalTx --> Send["发送增量到服务器"]
RemoteTx --> Apply["应用增量并触发重渲染"]
Send --> Broadcast["服务器广播增量"]
Broadcast --> Receive["接收并应用增量"]
Receive --> Render
Apply --> Render
```

图表来源
- [packages/editor/src/editor/collaboration.tsx](file://packages/editor/src/editor/collaboration.tsx#L1-L142)
- [packages/plugin-main/src/pages/Journals/JournalEditor/index.tsx](file://packages/plugin-main/src/pages/Journals/JournalEditor/index.tsx#L1-L54)

章节来源
- [packages/editor/src/editor/collaboration.tsx](file://packages/editor/src/editor/collaboration.tsx#L1-L142)
- [packages/plugin-main/src/pages/Journals/JournalEditor/index.tsx](file://packages/plugin-main/src/pages/Journals/JournalEditor/index.tsx#L1-L54)

### 同步块（SyncBlock）设计与实现
- SyncBlock 是一个原子化的块节点，用于承载独立的协作编辑上下文
- 每个块拥有独立的 Y.Doc 与 Provider，形成内容块级的协作域
- 通过 Collaboration.configure 将块的 Y.Doc 注入编辑器扩展，实现块内增量同步
- 块级 Provider 使用统一的 baseUrl 与按块命名的 name/token，确保频道隔离

```mermaid
classDiagram
class SyncBlock {
+名称 : "syncBlock"
+分组 : "block"
+隔离 : true
+原子 : true
+属性 : id, content, init
+渲染HTML
+添加节点视图
}
class SyncBlockView {
+格式化频道键
+创建独立 Doc/Provider
+注入 Collaboration 扩展
+渲染子编辑器
+清理连接
}
SyncBlock --> SyncBlockView : "节点视图渲染"
SyncBlockView --> Collaboration : "配置协作文档"
```

图表来源
- [packages/editor/src/extensions/sync-block/sync-block.ts](file://packages/editor/src/extensions/sync-block/sync-block.ts#L1-L40)
- [packages/editor/src/extensions/sync-block/SyncBlock.tsx](file://packages/editor/src/extensions/sync-block/SyncBlock.tsx#L1-L87)

章节来源
- [packages/editor/src/extensions/sync-block/sync-block.ts](file://packages/editor/src/extensions/sync-block/sync-block.ts#L1-L40)
- [packages/editor/src/extensions/sync-block/SyncBlock.tsx](file://packages/editor/src/extensions/sync-block/SyncBlock.tsx#L1-L87)

### Hocuspocus 协作服务器
- 服务端通过 Server.configure 配置扩展，示例中包含数据库与缓存扩展，以及日志扩展
- 通过环境变量控制端口与后端存储参数
- 服务器启动后监听连接，依据频道（name）进行广播与持久化

```mermaid
flowchart TD
Config["加载配置与扩展"] --> Listen["启动监听端口"]
Listen --> Accept["接受客户端连接"]
Accept --> Subscribe["订阅频道name"]
Subscribe --> Persist["持久化/广播"]
Persist --> Broadcast["向订阅者广播增量"]
```

图表来源
- [packages/editor/src/server/server.mjs](file://packages/editor/src/server/server.mjs#L1-L26)
- [packages/editor/package.json](file://packages/editor/package.json#L1-L104)

章节来源
- [packages/editor/src/server/server.mjs](file://packages/editor/src/server/server.mjs#L1-L26)
- [packages/editor/package.json](file://packages/editor/package.json#L1-L104)

### 协作状态管理（光标、选区、在线用户）
- 在线用户与用户状态（含光标、选区）通过 Awareness 机制共享
- 客户端在 Provider 中注册 onAwarenessUpdate 回调，解析 states 并维护本地用户列表
- 编辑器侧提供协作光标样式类名，用于渲染他人的光标与标签

```mermaid
sequenceDiagram
participant C1 as "客户端A"
participant C2 as "客户端B"
participant Provider as "Provider"
participant Server as "Hocuspocus 服务器"
C1->>Provider : 设置 Awareness用户信息/光标/选区
Provider->>Server : 上报 Awareness
Server-->>Provider : 广播 Awareness
Provider-->>C2 : 触发 onAwarenessUpdate
C2->>C2 : 更新本地用户列表与光标样式
```

图表来源
- [packages/plugin-main/src/pages/Journals/JournalEditor/index.tsx](file://packages/plugin-main/src/pages/Journals/JournalEditor/index.tsx#L1-L54)
- [packages/editor/src/styles/editor.ts](file://packages/editor/src/styles/editor.ts#L740-L802)

章节来源
- [packages/plugin-main/src/pages/Journals/JournalEditor/index.tsx](file://packages/plugin-main/src/pages/Journals/JournalEditor/index.tsx#L1-L54)
- [packages/editor/src/styles/editor.ts](file://packages/editor/src/styles/editor.ts#L740-L802)

### 冲突检测与自动解决（基于 Yjs 的 CRDT）
- Yjs 采用 CRDT（冲突无关复制数据类型），通过操作转换（OT）与因果关系保证最终一致性
- 当多个客户端并发修改同一文档时，Yjs 自动计算可交换的变换并合并，避免锁与回滚
- 历史记录模块在协作场景下对远程变更进行重映射与压缩，维持历史栈的正确性与性能

```mermaid
flowchart TD
A["本地事务生成"] --> B["计算可交换变换"]
B --> C["合并远程增量OT/CRDT"]
C --> D{"是否可直接应用?"}
D --> |是| E["应用并生成新事务"]
D --> |否| F["重映射/压缩历史项"]
F --> E
E --> G["广播增量"]
```

图表来源
- [packages/editor/src/extensions/undo-redo/history.ts](file://packages/editor/src/extensions/undo-redo/history.ts#L88-L204)

章节来源
- [packages/editor/src/extensions/undo-redo/history.ts](file://packages/editor/src/extensions/undo-redo/history.ts#L88-L204)

## 依赖关系分析
- 编辑器前端依赖 @hocuspocus/provider 与 @tiptap/extension-collaboration，结合 yjs 实现协作
- 服务器端依赖 @hocuspocus/server 与多种扩展（MySQL/Redis/Logger），实现持久化与分布式广播
- 页面与块编辑器均通过 Provider 进行连接管理，页面使用统一频道，块使用独立频道

```mermaid
graph LR
Pkg["@kn/editor 包"] --> Dep1["@hocuspocus/provider"]
Pkg --> Dep2["@tiptap/extension-collaboration"]
Pkg --> Dep3["yjs"]
Pkg --> Dep4["@hocuspocus/server"]
Page["页面编辑器"] --> Prov["@hocuspocus/provider"]
Block["同步块编辑器"] --> Prov
Prov --> Srv["@hocuspocus/server"]
Srv --> Ext1["@hocuspocus/extension-mysql"]
Srv --> Ext2["@hocuspocus/extension-redis"]
Srv --> Ext3["@hocuspocus/extension-logger"]
```

图表来源
- [packages/editor/package.json](file://packages/editor/package.json#L1-L104)
- [packages/editor/src/server/server.mjs](file://packages/editor/src/server/server.mjs#L1-L26)

章节来源
- [packages/editor/package.json](file://packages/editor/package.json#L1-L104)
- [packages/editor/src/server/server.mjs](file://packages/editor/src/server/server.mjs#L1-L26)

## 性能考虑
- 增量同步
  - 仅传输增量事务，减少带宽占用；服务器按频道广播，避免全量同步
- 内存管理
  - 块级协作使用独立 Doc，降低单文档规模，便于 GC 与局部重渲染
  - Provider 生命周期内及时断开与销毁，防止内存泄漏
- 网络优化
  - 使用稳定的 WebSocket 连接与重连策略；在高并发场景建议启用 Redis 扩展提升广播效率
- 历史与重映射
  - 历史模块对远程变更进行重映射与压缩，避免历史栈膨胀导致性能下降

章节来源
- [packages/editor/src/extensions/sync-block/SyncBlock.tsx](file://packages/editor/src/extensions/sync-block/SyncBlock.tsx#L1-L87)
- [packages/editor/src/extensions/undo-redo/history.ts](file://packages/editor/src/extensions/undo-redo/history.ts#L88-L204)
- [packages/editor/src/server/server.mjs](file://packages/editor/src/server/server.mjs#L1-L26)

## 故障排除指南
- 连接失败
  - 检查服务器地址与端口配置，确认网络可达
  - 查看 Provider 的 onStatus 回调与日志扩展输出
- 同步异常
  - 确认频道（name/token）唯一且一致；块级频道应包含块标识
  - 检查 Provider 是否在组件卸载时正确断开与销毁
- 光标/选区不显示
  - 确认 Awareness 已正确上报与接收；检查样式类名是否生效
- 性能问题
  - 大文档或高并发场景建议拆分块级协作；启用 Redis 扩展优化广播
  - 关注历史栈长度与重映射开销，必要时调整深度或触发压缩

章节来源
- [packages/plugin-main/src/pages/Journals/JournalEditor/index.tsx](file://packages/plugin-main/src/pages/Journals/JournalEditor/index.tsx#L1-L54)
- [packages/editor/src/extensions/sync-block/SyncBlock.tsx](file://packages/editor/src/extensions/sync-block/SyncBlock.tsx#L1-L87)
- [packages/editor/src/styles/editor.ts](file://packages/editor/src/styles/editor.ts#L740-L802)
- [packages/editor/src/server/server.mjs](file://packages/editor/src/server/server.mjs#L1-L26)

## 结论
本系统以 Yjs 为核心，借助 Hocuspocus 提供的协作框架，实现了页面与内容块两级的实时协作编辑。通过频道隔离与增量同步，系统在保证一致性的同时具备良好的扩展性与性能表现。配合 Awareness 机制与样式体系，实现了用户光标与选区的可视化协作。未来可在历史深度控制、广播优化与持久化策略上进一步细化，以适配更大规模的协作场景。